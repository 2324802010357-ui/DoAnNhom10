@model List<DoAnNhom10.Models.CartItem>

@{
    ViewBag.Title = "Giỏ hàng";
    var total = Model != null && Model.Any() ? Model.Sum(x => x.Total) : 0;
    var itemCount = Model != null ? Model.Sum(x => x.Quantity) : 0;
    var shippingFee = total >= 500000 ? 0 : 30000;
    var finalTotal = total + shippingFee;
}

<div class="container">
    <!-- Cart Header -->
    <div class="section-title">
        <h2><i class="fas fa-shopping-cart"></i> Giỏ hàng của bạn</h2>
        <p><span id="cart-count">@itemCount</span> sản phẩm trong giỏ hàng</p>
    </div>

    @if (Model == null || Model.Count == 0)
    {
        <!-- Empty Cart -->
        <div class="empty-cart">
            <div class="empty-cart-content">
                <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                <h3>Giỏ hàng của bạn đang trống</h3>
                <p class="text-muted">Hãy khám phá các sản phẩm tuyệt vời của chúng tôi!</p>
                <a href="@Url.Action("Index", "Products")" class="btn btn-primary btn-lg">
                    <i class="fas fa-shopping-bag"></i> Tiếp tục mua sắm
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8">
                <div class="cart-items">
                    @foreach (var item in Model)
                    {
                        <div class="cart-item" id="cart-item-@item.ProductID" data-product-id="@item.ProductID" data-price="@item.Price">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="product-image">
                                        <img src="@Url.Content(item.ImageUrl)" alt="@item.ProductName" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="product-info">
                                        <h5 class="product-name">@item.ProductName</h5>
                                        <div class="product-meta">
                                            <span class="text-muted">SKU: #@item.ProductID</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="product-price">
                                        <span class="price">@item.Price.ToString("N0")đ</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="quantity-controls">
                                        <div class="quantity-input-group" id="qty-group-@item.ProductID">
                                            <button type="button" class="quantity-btn minus" onclick="changeQuantity(@item.ProductID, @(item.Quantity - 1))">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number"
                                                   value="@item.Quantity"
                                                   min="1"
                                                   max="99"
                                                   class="quantity-input"
                                                   id="qty-@item.ProductID"
                                                   onchange="changeQuantity(@item.ProductID, this.value)" />
                                            <button type="button" class="quantity-btn plus" onclick="changeQuantity(@item.ProductID, @(item.Quantity + 1))">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="item-total">
                                        <span class="total-price" id="total-@item.ProductID">@item.Total.ToString("N0")đ</span>
                                        <button type="button" class="remove-btn" onclick="removeItem(@item.ProductID)" title="Xóa sản phẩm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Cart Actions -->
                <div class="cart-actions">
                    <a href="@Url.Action("Index", "Products")" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearCart()">
                        <i class="fas fa-trash"></i> Xóa tất cả
                    </button>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h4><i class="fas fa-receipt"></i> Tóm tắt đơn hàng</h4>

                    <div class="summary-row">
                        <span>Tạm tính (<span id="summary-count">@itemCount</span> sản phẩm):</span>
                        <span id="summary-subtotal">@total.ToString("N0")đ</span>
                    </div>

                    <div class="summary-row">
                        <span>Phí vận chuyển:</span>
                        <span class="text-success" id="shipping-fee">
                            @if (shippingFee == 0)
                            {
                                <span>Miễn phí</span>
                            }
                            else
                            {
                                <span>@shippingFee.ToString("N0")đ</span>
                            }
                        </span>
                    </div>

                    @if (total < 500000 && total > 0)
                    {
                        <div class="shipping-notice">
                            <i class="fas fa-info-circle"></i>
                            Mua thêm <strong>@((500000 - total).ToString("N0"))đ</strong> để được miễn phí vận chuyển!
                        </div>
                    }

                    <div class="summary-divider"></div>

                    <div class="summary-total">
                        <span>Tổng cộng:</span>
                        <span class="total-amount" id="final-total">@finalTotal.ToString("N0")đ</span>
                    </div>

                    <!-- Promo Code -->
                    <div class="promo-code">
                        <h6><i class="fas fa-tag"></i> Mã giảm giá</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Nhập mã giảm giá" id="promoCode">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="applyPromoCode()">
                                    Áp dụng
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <div class="checkout-section">
                        @if (Session["USER"] != null)
                        {
                            <a href="@Url.Action("Checkout", "Cart")" class="btn btn-success btn-block btn-lg checkout-btn">
                                <i class="fas fa-credit-card"></i> Thanh toán ngay
                            </a>
                        }
                        else
                        {
                            <p class="text-muted text-center mb-3">
                                <i class="fas fa-info-circle"></i> Bạn cần đăng nhập để thanh toán
                            </p>
                            <a href="@Url.Action("Login", "Account")" class="btn btn-primary btn-block">
                                <i class="fas fa-sign-in-alt"></i> Đăng nhập
                            </a>
                            <a href="@Url.Action("Register", "Account")" class="btn btn-outline-success btn-block">
                                <i class="fas fa-user-plus"></i> Đăng ký tài khoản
                            </a>
                        }
                    </div>

                    <!-- Security Badge -->
                    <div class="security-badges">
                        <div class="security-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Thanh toán an toàn</span>
                        </div>
                        <div class="security-item">
                            <i class="fas fa-truck"></i>
                            <span>Giao hàng nhanh chóng</span>
                        </div>
                        <div class="security-item">
                            <i class="fas fa-undo"></i>
                            <span>Đổi trả dễ dàng</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Hidden forms for cart updates -->
@foreach (var item in Model ?? new List<DoAnNhom10.Models.CartItem>())
{
    using (Html.BeginForm("Update", "Cart", FormMethod.Post, new { id = "form-update-" + item.ProductID, style = "display: none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@item.ProductID" />
        <input type="hidden" name="qty" id="hidden-qty-@item.ProductID" value="@item.Quantity" />
    }
}

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var isUpdating = false;

        function changeQuantity(productId, newQuantity) {
            if (isUpdating) return false;

            var qty = parseInt(newQuantity);
            if (isNaN(qty) || qty < 1) qty = 1;
            if (qty > 99) qty = 99;

            var input = document.getElementById('qty-' + productId);
            var qtyGroup = document.getElementById('qty-group-' + productId);
            var hiddenInput = document.getElementById('hidden-qty-' + productId);

            input.value = qty;
            hiddenInput.value = qty;

            qtyGroup.style.opacity = '0.6';
            qtyGroup.style.pointerEvents = 'none';
            isUpdating = true;

            var loadingIcon = document.createElement('div');
            loadingIcon.className = 'loading-overlay';
            loadingIcon.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
            qtyGroup.style.position = 'relative';
            qtyGroup.appendChild(loadingIcon);

            updateLocalCalculation(productId, qty);

            setTimeout(function () {
                var form = document.getElementById('form-update-' + productId);
                if (form) form.submit();
                else window.location.reload();
            }, 300);
        }

        function updateLocalCalculation(productId, newQuantity) {
            var cartItem = document.getElementById('cart-item-' + productId);
            var price = parseFloat(cartItem.dataset.price);
            var newTotal = price * newQuantity;

            var totalElement = document.getElementById('total-' + productId);
            if (totalElement) totalElement.textContent = newTotal.toLocaleString() + 'đ';

            updateCartSummaryLocal();
        }

        function updateCartSummaryLocal() {
            var totalQuantity = 0, subtotal = 0;

            document.querySelectorAll('.quantity-input').forEach(function (input) {
                var productId = input.id.replace('qty-', '');
                var cartItem = document.getElementById('cart-item-' + productId);
                var price = parseFloat(cartItem.dataset.price);
                var quantity = parseInt(input.value) || 0;
                totalQuantity += quantity;
                subtotal += price * quantity;
            });

            document.getElementById('cart-count').textContent = totalQuantity;
            document.getElementById('summary-count').textContent = totalQuantity;
            document.getElementById('summary-subtotal').textContent = subtotal.toLocaleString() + 'đ';

            var shippingFee = subtotal >= 500000 ? 0 : 30000;
            var finalTotal = subtotal + shippingFee;
            document.getElementById('final-total').textContent = finalTotal.toLocaleString() + 'đ';

            var shippingElement = document.getElementById('shipping-fee');
            shippingElement.innerHTML = shippingFee === 0 ? '<span>Miễn phí</span>' : '<span>' + shippingFee.toLocaleString() + 'đ</span>';

            var cartBadge = document.querySelector('.cart-badge');
            if (cartBadge) cartBadge.textContent = totalQuantity;
        }

        function removeItem(productId) {
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                var cartItem = document.getElementById('cart-item-' + productId);
                cartItem.style.transition = 'all 0.3s ease';
                cartItem.style.opacity = '0.5';
                cartItem.style.transform = 'translateX(-20px)';

                setTimeout(function () {
                    var form = $('<form>', { method: 'POST', action: '@Url.Action("Remove", "Cart")' });
                    form.append($('<input>', { type: 'hidden', name: 'id', value: productId }));
                    form.append($('@Html.AntiForgeryToken()'));
                    $('body').append(form);
                    form.submit();
                }, 300);
            }
        }

        function clearCart() {
            window.location.href = '@Url.Action("Clear", "Cart")';
        }

        function applyPromoCode() {
            var code = $('#promoCode').val().trim();
            if (code) {
                alert('Chức năng mã giảm giá sẽ sớm được cập nhật!');
            } else {
                alert('Vui lòng nhập mã giảm giá!');
            }
        }

        $(document).ready(function () {
            // ✅ Khi bấm "Thanh toán ngay"
            $('.checkout-btn').on('click', function (e) {
                e.preventDefault();

                Swal.fire({
                    icon: 'success',
                    title: 'Thanh toán thành công!',
                    text: 'Cảm ơn bạn đã mua sắm tại Fashion Store 💜',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6a5acd'
                }).then(() => {
                    // Gọi action Clear để xóa giỏ hàng
                    window.location.href = '@Url.Action("ClearAfterPayment", "Cart")';
                });
            });

            // Validate số lượng
            $('.quantity-input').on('input', function () {
                var value = parseInt(this.value);
                if (isNaN(value) || value < 1) this.value = 1;
                if (value > 99) this.value = 99;
            });
        });
    </script>

    <style>
        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: #667eea;
        }

        .quantity-input-group {
            position: relative;
        }
    </style>

    @Html.AntiForgeryToken()
}

